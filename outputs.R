# SUMMARY STATS ----------------------------------------------------------------
source ("moduleServer.R", local = TRUE)
source ("reactives.R", local = TRUE)

allowedColors = unique(c("#8c510a","#d8b365","#f6e8c3","#c7eae5","#5ab4ac","#01665e","#c51b7d","#e9a3c9",
                  "#fde0ef","#e6f5d0","#a1d76a","#4d9221","#762a83","#af8dc3","#e7d4e8","#d9f0d3",
                  "#7fbf7b","#1b7837","#b35806","#f1a340","#fee0b6","#d8daeb","#998ec3","#542788",
                  "#b2182b","#ef8a62","#fddbc7","#d1e5f0","#67a9cf","#2166ac","#b2182b","#ef8a62",
                  "#fddbc7","#e0e0e0","#999999","#4d4d4d"))

# normalizationRadioButtonValue -------------------------------- Parameters / normalization
output$normalizationRadioButtonValue <- renderPrint({
  input$normalizationRadioButton
})

normaliztionParameters <- list(raw = "no Parameters needed")
parFiles <- dir(path = "contributions", pattern = "parameters.R", full.names = TRUE, recursive = TRUE)
for (fp in parFiles) {
  myNormalizationParameters <- list()
  source(fp, local = TRUE)
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/normalizationsParameters.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load(file = '~/scShinyHubDebug/normalizationsParameters.RData')
  if (length(myNormalizationParameters) > 0) {
    for (li in 1:length(myNormalizationParameters)) {
      lVal <- myNormalizationParameters[[li]]
      if (length(lVal) > 0) {
        if (DEBUG) {
          cat(file = stderr(), paste("normalization Choice: ", names(myNormalizationParameters)[li], " ", lVal, "\n"))
          cat(file = stderr(), paste("class: ", class(myNormalizationParameters[[li]]), " ", lVal, "\n"))
        }
        oldNames <- names(normaliztionParameters)
        normaliztionParameters[[length(normaliztionParameters) + 1]] <- lVal
        names(normaliztionParameters) <- c(oldNames, names(myNormalizationParameters)[li])
      }
    }
  }
}

# normalizationsParametersDynamic -------------------------
output$normalizationsParametersDynamic <- renderUI({
  if (is.null(input$normalizationRadioButton)) {
    return(NULL)
  }
  selectedChoice <- input$normalizationRadioButton

  if (DEBUG) {
    cat(file = stderr(), paste(class(normaliztionParameters)), "\n")
    cat(file = stderr(), paste(length(normaliztionParameters)), "\n")
    for (li in normaliztionParameters) {
      if (length(li) > 0) {
        if (DEBUG) {
          cat(file = stderr(), paste("normaliztionParameters: ", li, "\n"))
        }
        if (DEBUG) {
          cat(file = stderr(), paste("normaliztionParameters: ", names(li), "\n"))
        }
      }
    }
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/normalizationsParametersDynamic.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load(file = '~/scShinyHubDebug/normalizationsParametersDynamic.RData')
  do.call("switch", args = c(selectedChoice, normaliztionParameters, h3("no parameters provided")))
})


# summaryStatsSideBar -----------------------------
output$summaryStatsSideBar <- renderUI({
  if (DEBUG) {
    cat(file = stderr(), "output$summaryStatsSideBar\n")
  }
  scEx <- scEx()
  if (is.null(scEx)) {
    if (DEBUG) {
      cat(file = stderr(), "output$summaryStatsSideBar:NULL\n")
    }
    return(NULL)
  }
  if (input$noStats) {
    if (DEBUG) {
      cat(file = stderr(), "output$summaryStatsSideBar:off\n")
    }
    return(NULL)
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/summaryStatsSideBar.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load("~/scShinyHubDebug/summaryStatsSideBar.RData")
  line0 <- paste(input$file1$name)
  line1 <- paste("No. of cells: ", dim(scEx)[2], sep = "\t")
  line2 <- paste("No. of genes: ", dim(scEx)[1], sep = "\t")
  line3 <- paste("Median UMIs per cell: ", medianUMI(), sep = "\t")
  line4 <- paste("Median Genes with min 1 UMI: ", medianENSG(), sep = "\t")
  line5 <- paste("Total number of reads: ", sum(assays(scEx)[["counts"]]))
  line6 <- paste("Memory used:", getMemoryUsed())
  line7 <- paste("Normalization used:", input$normalizationRadioButton)
  htmlOut <- paste0(
    "Summary statistics of this dataset:", "<br/>", "<br/>", line0, "<br/>",  line1, "<br/>", line2, "<br/>", line3, "<br/>", line4, "<br/>",
    line5, "<br/>", line6, "<br/>", line7
  )
  exportTestValues(summaryStatsSideBar = { htmlOut })
  
  HTML(htmlOut)
})


# Select Genes ----
# this is part of the basic functionality from this
# tools and thus, can stay in this file.
output$geneListSelection <- renderTree({
  geneLists
})

# selectedGenesTable ----
# ONOFF TAB RENDER TABLE ALL CELLS 
# TODO module for DT this is part
# of the basic functionality from this tools and thus, can stay in this file.
output$selectedGenesTable <- DT::renderDataTable({
  if (DEBUG) {
    cat(file = stderr(), "output$selectedGenesTable\n")
  }
  dataTables <- inputData()
  useGenes <- useGenes()
  useCells <- useCells()
  if (is.null(dataTables) | is.null(useGenes) | is.null(useCells)) {
    return(NULL)
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/selectedGenesTable.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load("~/scShinyHubDebug/selectedGenesTable.RData")
  
  scEx <- assays(dataTables$scEx)[[1]]
  fd <- dataTables$featuredata
  dt <- fd[useGenes, c("Associated.Gene.Name", "Gene.Biotype", "Description")]
  dt$rowSums <- Matrix::rowSums(scEx[useGenes, useCells])
  dt$rowSamples <- Matrix::rowSums(scEx[useGenes, useCells] > 0)
  exportTestValues(selectedGenesTable = { as.data.frame(dt) })
  DT::datatable(as.data.frame(dt))
})

# removedGenesTable -------------------------- 
# TODO module for DT TODO move to were it belongs
output$removedGenesTable <- DT::renderDataTable({
  if (DEBUG) {
    cat(file = stderr(), "output$removedGenesTable\n")
  }
  dataTables <- inputData()
  useGenes <- useGenes()
  useCells <- useCells()
  if (is.null(dataTables) | is.null(useGenes) | is.null(useCells)) {
    return(NULL)
  }
  useGenes <- !useGenes

  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/removedGenesTable.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load("~/scShinyHubDebug/removedGenesTable.RData")
  scEx <- assays(dataTables$scEx)[[1]]
  fd <- dataTables$featuredata
  dt <- fd[useGenes, c("Associated.Gene.Name", "Gene.Biotype", "Description")]
  dt$rowSums <- Matrix::rowSums(scEx[useGenes, useCells])
  dt$rowSamples <- Matrix::rowSums(scEx[useGenes, useCells] > 0)
  exportTestValues(removedGenesTable = { as.data.frame(dt) })
  DT::datatable(as.data.frame(dt))
})

# gsSelectedGenes --------------------------- 
# TODO module of DT with selected names above Print names of selected genes for gene
# selection above table
output$gsSelectedGenes <- renderText({
  if (DEBUG) {
    cat(file = stderr(), "gsSelectedGenes\n")
  }
  dataTables <- inputData()
  useGenes <- useGenes()
  useCells <- useCells()
  selectedGenesTable_rows_selected <- input$selectedGenesTable_rows_selected
  if (is.null(dataTables) | is.null(useGenes) | is.null(useCells)) {
    return(NULL)
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/gsSelectedGenes.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load("~/scShinyHubDebug/gsSelectedGenes.RData")
  
  # scEx <- as.matrix(exprs(dataTables$scEx))
  fd <- dataTables$featuredata
  dt <- fd[useGenes, c("Associated.Gene.Name", "Gene.Biotype", "Description")]
  retVal <- paste0(dt$Associated.Gene.Name[selectedGenesTable_rows_selected], ",")
  exportTestValues(gsSelectedGenes = { retVal })
  return(retVal)
})

# gsrmGenes ----------------- 
# Print names of removed genes for gene selection
output$gsrmGenes <- renderText({
  if (DEBUG) {
    cat(file = stderr(), "gsrmGenes\n")
  }
  dataTables <- inputData()
  useGenes <- useGenes()
  useCells <- useCells()
  removedGenesTable_rows_selected <- input$removedGenesTable_rows_selected
  if (is.null(dataTables) | is.null(useGenes) | is.null(useCells)) {
    return(NULL)
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/gsrmGenes.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load("~/scShinyHubDebug/gsrmGenes.RData")
  
  # scEx <- as.matrix(exprs(dataTables$scEx))
  fd <- dataTables$featuredata
  dt <- fd[useGenes, c("Associated.Gene.Name", "Gene.Biotype", "Description")]
  if (DEBUG) {
    cat(file = stderr(), "gsrmGenes: done\n")
  }
  retVal <-  paste0(dt$Associated.Gene.Name[removedGenesTable_rows_selected], ",")
  exportTestValues(gsrmGenes = { retVal })
  return(retVal)
})

# DEBUGSAVEstring ----
output$DEBUGSAVEstring <- renderText({
  if (DEBUG){
  DEBUGSAVE <<- input$DEBUGSAVE
  } else {
    NULL
  }
})

# cellSelectionMod ----
callModule(tableSelectionServer, "cellSelectionMod", inputSample)

# normalizationResult ----
callModule(tableSelectionServer, "normalizationResult", scExLogMatrixDisplay)

output$descriptOfWorkOutput <- renderPrint({
  input$descriptionOfWork
})

# sampleColorSelection ----
output$sampleColorSelection <- renderUI({ 
  scEx <- scEx()
  isolate({sampCol = sampleCols$colPal})
  
  if (is.null(scEx) ) {
    return(NULL)
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/sampleColorSelection.RData", list = c("normaliztionParameters", ls(), ls(envir = globalenv())))
  }
  # load("~/scShinyHubDebug/sampleColorSelection.RData")
  
  lev <- levels(colData(scEx)$sampleNames)
  # cols <- gg_fill_hue(length(lev))
  
  # New IDs "colX1" so that it partly coincide with input$select...
  lapply(seq_along(lev), function(i) {
    colourpicker::colourInput(inputId = paste0("sampleNamecol", lev[i]),
                              label = paste0("Choose colour for sample ","\"", lev[i],"\""), 
                              # value = "#762A83"
                              # ,
                              value = sampCol[i],
                              allowedCols = allowedColors,
                              palette = "limited"
    )        
  })
})

# observe: input$updateColors ----
observeEvent(input$updateColors, {
  cat(file = stderr(), paste0("observeEvent input$updateColors\n"))
  scExx <- scEx()
  if (is.null(scExx) ) {
    return(NULL)
  }
  scols = sampleCols$colPal
  inCols = list()
  lev <- levels(colData(scExx)$sampleNames)

  inCols <- lapply(seq_along(lev), function(i){
     input[[paste0("sampleNamecol", lev[i])]]
  })
  names(inCols) = lev
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/updateColors.RData", list = c(ls(), ls(envir = globalenv())))
    cat(file = stderr(), paste0("observeEvent save done\n"))
  }
  # load(file="~/scShinyHubDebug/updateColors.RData")
  
  isolate({
    sampleCols$colPal = unlist(inCols)
  })
})

# Nclusters ----
output$Nclusters <- renderText({
  kmClustering = kmClustering()
  if (is.null(kmClustering)) {
    return(NULL)
  }
  if (DEBUGSAVE) {
    save(file = "~/scShinyHubDebug/Nclusters.RData", list = c(ls(), ls(envir = globalenv())))
    cat(file = stderr(), paste0("observeEvent save done\n"))
  }
  # load(file="~/scShinyHubDebug/Nclusters.RData")
  retVal <- paste(levels(kmClustering$Cluster))
  exportTestValues(Nclusters = { retVal })
  return(retVal)
})


if (DEBUG) {
  cat(file = stderr(), paste("end: outputs.R\n"))
}

