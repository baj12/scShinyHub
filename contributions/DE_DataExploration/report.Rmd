---
title: "child report"
output: html_document
---

# Data exploration

```{r bj-DE-setup, echo=TRUE, warning=FALSE}
if(exists("params")){
  cat(file=stderr(), paste("Scater Plot report\n"))
}else{
  rm(list = ls())
  load("~/scShinyHubDebug/report.RData")
  cat(file=stderr(), getwd())
  
  require(shiny)
  require(plotly)
  require(shinythemes)
  require(ggplot2)
  require(DT)
  require(pheatmap)
  require(threejs)
  require(sm)
  require(RColorBrewer)
  require(mclust)
  require(reshape)
  # require(cellrangerRkit)
  # require(SCORPIUS)
  require(ggplot2)
  require(knitr)
  require(kableExtra)
  require(shinyWidgets)
  require(scater)
  
  source("../../../serverFunctions.R")
  source("../../../reactives.R", local = TRUE)
  # source("reactives.R", local = TRUE)
  
  LOCALEXECUTION = TRUE # to know that we are debugging.
  useCells = useCellsFunc(dataTables, 
                          geneNames = input$minExpGenes,
                          rmCells = input$cellsFiltersOut,
                          rmPattern = input$cellPatternRM,
                          keepCells = input$cellKeep,
                          cellKeepOnly = input$cellKeepOnly)
  ipIDs = input$selectIds
  geneListSelection = input$geneListSelection
  minGene <- input$minGenesGS
  
  useGenes = useGenesFunc(dataTables, useCells, ipIDs, geneListSelection, minGene)
  featureDataReact = dataTables$featuredata[useGenes, ]
  featureData = dataTables$featuredata[useGenes, ]
  scEx = assays(dataTables$scEx)[[1]][useGenes, useCells]
  scEx_log = assays(dataTables$scEx_log)[[1]][useGenes, useCells]
  log2cpm = dataTables$log2cpm[useGenes, useCells]
  
}
```


## normalization

Normalization method used: `r input$normalizationRadioButton` used.


`r input$scaterGeneList`

`r input$scaterGeneListRM`


## Expression 

2D plot 

g_id <- `r input$DE_gene_id`
geneNames <- `r input$"DE_expclusters-geneIds"`
clId <- `r input$"DE_expclusters-clusters"`
dimX <- `r input$"DE_expclusters-dimension_x"`
dimY <- `r input$"DE_expclusters-dimension_y"`


```{r bj-DE-2Dprojection, echo=TRUE, eval=FALSE}

g_id <- input$DE_gene_id
geneNames <- input$"DE_expclusters-geneIds"
#TODO geneNames2 is just added to have a value, need to check how this should behave.
geneNames2 <- input$"DE_expclusters-geneIds"
clId <- input$"DE_expclusters-clusters"
dimX <- input$"DE_expclusters-dimension_x"
dimY <- input$"DE_expclusters-dimension_y"
divXBy <- input$devideXBy
divYBy <- input$devideYBy
scols <- sampleCols$colPal
ccols <- clusterCols$colPal

legend.position <- "none"
grpN <- make.names(input$groupName)
cat(file = stderr(), paste("2Dprojection", c(g_id, geneNames, dimX, dimY, clId, grpN, legend.position)))

# save(file = "~/scShinyHubDebug/bj.DE.2Dprojection.Rdata", list = ls())
# load(file = "~/scShinyHubDebug/bj.DE.2Dprojection.Rdata")
 if (dimCol == "sampleNames") {
    myColors <- scols
  } else {
    myColors <- NULL
  }
if (dimCol == "dbCluster") {
    myColors <- ccols
  }


plot2Dprojection(scEx_log, projections, g_id, featureData, geneNames, 
                 geneNames2, dimX, dimY, clId, grpN, legend.position, 
                 grpNs = groupNames$namesDF, divXBy = divXBy, divYBy = divYBy, dimCol = dimCol, colors = myColors)

```



## VIOLIN PLOT 

```{r bj-DE-DE_gene_vio_plot, eval=FALSE, echo=TRUE}
# geneid <- rownames(featureData[which(featureData$symbol %in%
#                                        toupper(input$DE_gene_id)), ])[1]
  genesin <- toupper(input$DE_gene_id)
  genesin <- gsub(" ", "", genesin, fixed = TRUE)
  genesin <- strsplit(genesin, ",")
  geneid <- rownames(featureData[which(featureData$symbol %in%
                                       genesin[[1]]), ])
  map <-
    rownames(featureData[which(featureData$symbol %in% genesin[[1]]), ])
  
 # expression <- Matrix::colSums(exprs(scEx[map, ]) >= minExpr)
 expression <- Matrix::colSums(assays(scEx)[[1]][map, ] >= minExpr)

  projections <- cbind(projections, coExpVal = expression)
  # if(class(projections[,dbCluster])=="factor"){
  

  p1 <-
    ggplot(projections, aes_string(factor(projections[, "dbCluster"]), "coExpVal", fill = factor(projections[, "dbCluster"]))) +
    geom_violin(scale = "width") +
    stat_summary(
      fun.y = median,
      geom = "point",
      size = 5,
      color = "black"
    ) +
    stat_summary(fun.data = n_fun, geom = "text") +
    theme_bw() +
    theme(
      axis.text.x = element_text(
        angle = 60,
        size = 12,
        vjust = 0.5
      ),
      axis.text.y = element_text(size = 12),
      strip.text.x = element_text(size = 16),
      strip.text.y = element_text(size = 14),
      axis.title.x = element_text(face = "bold", size = 16),
      axis.title.y = element_text(face = "bold", size = 16),
      legend.position = "none"
    ) +
    xlab("dbCluster") +
    ylab("number genes from list")
p1

```

## Panel plot
output$DE_panelPlot <- renderPlot({

input$DE_clusterSelectionPanelPlot : `r input$DE_clusterSelectionPanelPlot`

input$DE_panelplotids : `r input$DE_panelplotids`

input$DE_dim_x : `r input$DE_dim_x`

input$DE_dim_y : `r input$DE_dim_y`

```{r bj-DE-DE_panelPlot, eval=FALSE, echo=TRUE}

#@DO fix
# output$DE_panelPlot
# Quitting from lines 164-211 (/var/folders/_h/vtcnd09n2jdby90zkb6wyd740000gp/T//Rtmpw4FHir/filee53f2f5d5938.Rmd) 
# Quitting from lines NA-260 (/var/folders/_h/vtcnd09n2jdby90zkb6wyd740000gp/T//Rtmpw4FHir/filee53f2f5d5938.Rmd) 
# 
# 
# Warning: Error in seq.int: 'from' must be a finite number
#   [No stack trace available]


if(DEBUG)cat(file=stderr(), "output$DE_panelPlot\n")

genesin <- input$DE_panelplotids
genesin <- toupper(genesin)
genesin <- gsub(" ", "", genesin, fixed = TRUE)
genesin <- strsplit(genesin, ',')
genesin<-genesin[[1]]

par(mfrow=c(ceiling(length(genesin)/4),4), mai = c(0, 0., 0., 0.))
rbPal <- colorRampPalette(c('#f0f0f0','red'))

if (input$DE_clusterSelectionPanelPlot == 'All') 
{
  for (i in 1:length(genesin)){
    Col <- rbPal(10)[
      as.numeric(
        cut(
          as.numeric(
            log2cpm[
              rownames(featureData[which(featureData$symbol==genesin[i]),])
              ,]
          ),breaks = 10))]
    plot(projections[,input$DE_dim_x],projections[,input$DE_dim_y],col=Col,pch=16,axes = FALSE,frame.plot = TRUE, ann=FALSE)
    title(genesin[i],line=-1.2,adj = 0.05,cex.main=2)
  }
}else{
  for (i in 1:length(genesin)){
    
    subsetTSNE <- subset(projections, dbCluster == input$DE_clusterSelectionPanelPlot)
    
    Col <- rbPal(10)[
      as.numeric(
        cut(
          as.numeric(
            log2cpm[
              rownames(featureData[which(featureData$symbol==genesin[i]),])
              ,]
          ),breaks = 10))]
    
    names(Col)<-rownames(projections)
    plotCol<-Col[rownames(subsetTSNE)]
    plot(subsetTSNE[,input$DE_dim_x],subsetTSNE[,input$DE_dim_y],col=plotCol,pch=16,axes = FALSE,frame.plot = TRUE, ann=FALSE)
    title(genesin[i],line=-1.2,adj = 0.05,cex.main=2)
    
  }
}

```



## 3D TSNE plot

```{r bj-DE-DE_tsne_plt, eval=TRUE, echo=TRUE}
if(DEBUG)cat(file=stderr(), "output$DE_tsne_plt\n")
geneid <- rownames(featureData[which(featureData$symbol ==
                                       toupper(input$DE_gene_id)), ])[1]

expression <- log2cpm[geneid, ]

tsneData <- cbind(projections, t(expression))
names(tsneData)[names(tsneData) == geneid] <- 'values'

p <-
  plot_ly(
    tsneData,
    x = ~ tsne1,
    y = ~ tsne2,
    z = ~ tsne3,
    type = "scatter3d",
    hoverinfo = "text",
    text = paste('Cluster:', as.numeric(as.character(projections$dbCluster))),
    mode = 'markers',
    marker = list(
      size = 2,
      line = list(width = 0),
      color =  ~ values,
      colors = 'Greens'
    )
  )
layout(p, title = toupper(input$DE_gene_id))

```

## scater QC

```{r bj-DE-scater, eval=FALSE, echo=TRUE, warning=FALSE }
cat(file = stderr(), paste(class(scEx_log), collapse = "\n"))
featureDataReact <- dataTables$featuredata[useGenes, ]
# featureData = dataTables$featuredata[useGenes, ]
scaterReads <- gQC_scaterReadsFunc(scEx, featureDataReact)
n = min(nrow(scaterReads),50)
scater::plotQC(scaterReads, type = "highest-expression", colour_cells_by = "fixed", n = n)
```



