---
title: "subclusterreport"
output: html_document
---

# sub cluster analysis

```{r dge, eval=TRUE, echo=FALSE, results='asis'}
  
if(DEBUG)cat(file=stderr(), "dge\n")

if (is.null(input$db1) | is.null(input$db2)) {
  knit_exit()
}

```


## Plot 1

  x1 = `r input$subscluster_x1`
  
  y1 = `r input$subscluster_y1`
  
  c1 = `r input$dgeClustersSelection`
  
  gn <- `r dim(groupNames$namesDF)`



```{r selectedDge1, eval=TRUE, echo=FALSE}
# TODO module?  
  x1 = input$subscluster_x1
  y1 = input$subscluster_y1
<<<<<<< HEAD
  c1 = input$dgeClustersSelection
=======
  c1 = input$clusters1
>>>>>>> 012c5c303a29ae54541730abda33b3d4e1088f20
  gn <- groupNames$namesDF

  
  xmin <- input$db1$xmin
  xmax <- input$db1$xmax
  ymin <- input$db1$ymin
  ymax <- input$db1$ymax
  
  if (length(gn) > 0){
    projections = cbind(projections, gn[rownames(projections),]*1)
  }
  subsetData <- subset(projections, dbCluster %in% c1)
  p1 <-
    ggplot(subsetData,
           aes_string(x = x1, y = y1),
           colour = "dbCluster") +
    geom_point(aes(colour = dbCluster)) +
    geom_point(shape = 1,
               size = 4,
               aes(colour = dbCluster)) +
    annotate("rect",
             xmin = xmin, xmax = xmax,
             ymin = ymin, ymax = ymax,
             fill = "palegreen", alpha = 0.2) +
    theme_bw() +
    theme(
      axis.text.x = element_text(
        angle = 90,
        size = 12,
        vjust = 0.5
      ),
      axis.text.y = element_text(size = 12),
      strip.text.x = element_text(size = 16),
      strip.text.y = element_text(size = 14),
      axis.title.x = element_text(face = "bold", size = 16),
      axis.title.y = element_text(face = "bold", size = 16),
      legend.position = "none"
    ) +
    ggtitle(c1)
  p1
  
```

## SUBCLUSTER DGE PLOT2 

  gn <- `r dim(groupNames$namesDF)`
  
  inpCl1 <- `r input$dgeClustersSelection`


```{r dgePlot2, echo=FALSE}

  gn <- groupNames$namesDF
  inpCl1 <- input$dgeClustersSelection
  
  xmin <- input$db2$xmin
  xmax <- input$db2$xmax
  ymin <- input$db2$ymin
  ymax <- input$db2$ymax

  subsetData <- subset(projections, dbCluster %in% inpCl1)
  # save(file = "~/scShinyHubDebug/dge.Rmd.RData", list = c(ls(),ls(envir = globalenv())))
  # load(file = "~/scShinyHubDebug/dge.Rmd.RData")
  p1 <-
    ggplot(subsetData,
           aes_string(x = input$subscluster_y1, y = input$dimension_y1),
           color = "dbCluster") +
    geom_point(aes(colour = dbCluster)) +
    geom_point(shape = 1,
               size = 4,
               aes(colour = dbCluster)) +
    annotate("rect",
             xmin = xmin, xmax = xmax,
             ymin = ymin, ymax = ymax,
             fill = "palegreen", alpha = 0.2) +
    theme_bw() +
    theme(
      axis.text.x = element_text(
        angle = 90,
        size = 12,
        vjust = 0.5
      ),
      axis.text.y = element_text(size = 12),
      strip.text.x = element_text(size = 16),
      strip.text.y = element_text(size = 14),
      axis.title.x = element_text(face = "bold", size = 16),
      axis.title.y = element_text(face = "bold", size = 16),
      legend.position = "none"
    ) +
    ggtitle(input$dgeClustersSelection)
  p1

```

## DGE table


  gn <- `r dim(groupNames$namesDF)`
  
  cl1 = `r input$dgeClustersSelection`
  
  

```{r DGETable, eval=TRUE, echo=FALSE}
  gn <- groupNames$namesDF
  
  cl1 = input$dgeClustersSelection
  db1 = input$db1
  db2 = input$db2
  prj <- projections
  
  if (length(gn) > 0){
    prj = cbind(prj, gn[rownames(prj),]*1)
  }
  
  toReturn = dge_func(projections = prj, log2cpm = log2cpm, dbCluster = prj$dbCluster, cl1 = cl1, db1 = db1, db2 = db2)

    if(nrow(toReturn)==0){
    if(DEBUG)cat(file=stderr(), "dge: nothing found\n")
    if(!is.null(getDefaultReactiveDomain())){
      showNotification("dge: nothing found", id="dgewarning", duration = 10, type = 'warning')
    }
  }
  # selectedDge$dgeTable <- toReturn
  # cat(stderr(), rownames(toReturn)[1:5])

  # toReturn


  top.genes <-  toReturn
  top.genes$symbol <-
    featureData[rownames(top.genes), 'symbol']
DT::datatable(top.genes,
                  options = list(
                    orderClasses = TRUE,
                    lengthMenu = c(10, 30, 50),
                    pageLength = 10
                  ))


```

### download

```{r}

# save full table in tmp folder to be included in report
  write.csv(top.genes, file = paste0(input$reportTempDir, "/DGE.csv"))

```


Full table can be found here: [DGE.csv](DGE.csv)

