---
title: "child report"
output: html_document
---

# Data exploration

```{r bj-DE-setup, echo=FALSE, warning=FALSE}
if(exists("params")){
  cat(file=stderr(), paste("Scater Plot report\n"))
}else{
  rm(list = ls())
  load("~/scShinyHubDebug/report.RData")
  cat(file=stderr(), getwd())
  
  require(shiny)
  require(plotly)
  require(shinythemes)
  require(ggplot2)
  require(DT)
  require(pheatmap)
  require(threejs)
  require(sm)
  require(RColorBrewer)
  require(mclust)
  require(reshape)
  require(cellrangerRkit)
  require(SCORPIUS)
  require(ggplot2)
  require(knitr)
  require(kableExtra)
  require(shinyWidgets)
  require(scater)
  
  source("../../../serverFunctions.R")
  source("../../../reactives.R", local = TRUE)
  # source("reactives.R", local = TRUE)
  
  LOCALEXECUTION = TRUE # to know that we are debugging.
  useCells = useCellsFunc(dataTables, 
                          geneNames = input$minExpGenes,
                          rmCells = input$cellsFiltersOut,
                          rmPattern = input$cellPatternRM,
                          keepCells = input$cellKeep,
                          cellKeepOnly = input$cellKeepOnly)
  ipIDs = input$selectIds
  geneListSelection = input$geneListSelection
  minGene <- input$minGenesGS
  
  useGenes = useGenesFunc(dataTables, useCells, ipIDs, geneListSelection, minGene)
  featureDataReact = dataTables$featuredata[useGenes, ]
  featureData = dataTables$featuredata[useGenes, ]
  gbm = dataTables$gbm[useGenes, useCells]
  gbm_log = dataTables$gbm_log[useGenes, useCells]
  log2cpm = dataTables$log2cpm[useGenes, useCells]
  
}
```


## normalization

Normalization method used: `r input$normalizationRadioButton` used.


`r input$scaterGeneList`

`r input$scaterGeneListRM`


## Expression 

2D plot 

g_id <- `r input$gene_id`
geneNames <- `r input$"expclusters-geneIds"`
clId <- `r input$"expclusters-clusters"`
dimX <- `r input$"expclusters-dimension_x"`
dimY <- `r input$"expclusters-dimension_y"`


```{r bj-DE-2Dprojection, echo=FALSE, eval=TRUE}

g_id <- input$gene_id
geneNames <- input$"expclusters-geneIds"
clId <- input$"expclusters-clusters"
dimX <- input$"expclusters-dimension_x"
dimY <- input$"expclusters-dimension_y"
legend.position <- "none"
grpN <- make.names(input$groupName)
cat(file = stderr(), paste("2Dprojection", c(g_id, geneNames, dimX, dimY, clId, grpN, legend.position)))

# save(file = "~/scShinyHubDebug/bj.DE.2Dprojection.Rdata", list = ls())
# load(file = "~/scShinyHubDebug/bj.DE.2Dprojection.Rdata")

plot2Dprojection(gbm_log, gbm, projections, g_id, featureData, geneNames, dimX, dimY, clId, grpN, legend.position)

```



## VIOLIN PLOT 

```{r bj-DE-gene_vio_plot, eval=TRUE, echo=FALSE}
# geneid <- rownames(featureData[which(featureData$Associated.Gene.Name %in%
#                                        toupper(input$gene_id)), ])[1]
  genesin <- toupper(input$gene_id)
  genesin <- gsub(" ", "", genesin, fixed = TRUE)
  genesin <- strsplit(genesin, ",")
  geneid <- rownames(featureData[which(featureData$Associated.Gene.Name %in%
                                       genesin[[1]]), ])
  map <-
    rownames(featureData[which(featureData$Associated.Gene.Name %in% genesin[[1]]), ])
  
 expression <- colSums(as.matrix(exprs(gbm[map, ])) >= minExpr)

  projections <- cbind(projections, coExpVal = expression)
  # if(class(projections[,dbCluster])=="factor"){
  n_fun <- function(x) {
  return(data.frame(y = -.5, label = paste0(length(x), "\ncells")))
}

  p1 <-
    ggplot(projections, aes_string(factor(projections[, "dbCluster"]), "coExpVal", fill = factor(projections[, "dbCluster"]))) +
    geom_violin(scale = "width") +
    stat_summary(
      fun.y = median,
      geom = "point",
      size = 5,
      color = "black"
    ) +
    stat_summary(fun.data = n_fun, geom = "text") +
    theme_bw() +
    theme(
      axis.text.x = element_text(
        angle = 60,
        size = 12,
        vjust = 0.5
      ),
      axis.text.y = element_text(size = 12),
      strip.text.x = element_text(size = 16),
      strip.text.y = element_text(size = 14),
      axis.title.x = element_text(face = "bold", size = 16),
      axis.title.y = element_text(face = "bold", size = 16),
      legend.position = "none"
    ) +
    xlab("dbCluster") +
    ylab("number genes from list")
if(DEBUG)cat(file=stderr(), "output$gene_vio_plot:done\n")
p1

```

## Panel plot
output$panelPlot <- renderPlot({

input$clusters4 : `r input$clusters4`

input$panelplotids : `r input$panelplotids`

input$dimension_x4 : `r input$dimension_x4`

input$dimension_y4 : `r input$dimension_y4`

```{r bj-DE-panelPlot, eval=TRUE, echo=FALSE}
if(DEBUG)cat(file=stderr(), "output$panelPlot\n")

genesin <- input$panelplotids
genesin <- toupper(genesin)
genesin <- gsub(" ", "", genesin, fixed = TRUE)
genesin <- strsplit(genesin, ',')
genesin<-genesin[[1]]

par(mfrow=c(ceiling(length(genesin)/4),4), mai = c(0, 0., 0., 0.))
rbPal <- colorRampPalette(c('#f0f0f0','red'))

if (input$clusters4 == 'All') 
{
  for (i in 1:length(genesin)){
    Col <- rbPal(10)[
      as.numeric(
        cut(
          as.numeric(
            log2cpm[
              rownames(featureData[which(featureData$Associated.Gene.Name==genesin[i]),])
              ,]
          ),breaks = 10))]
    plot(projections[,input$dimension_x4],projections[,input$dimension_y4],col=Col,pch=16,axes = FALSE,frame.plot = TRUE, ann=FALSE)
    title(genesin[i],line=-1.2,adj = 0.05,cex.main=2)
  }
}else{
  for (i in 1:length(genesin)){
    
    subsetTSNE <- subset(projections, dbCluster == input$clusters4)
    
    Col <- rbPal(10)[
      as.numeric(
        cut(
          as.numeric(
            log2cpm[
              rownames(featureData[which(featureData$Associated.Gene.Name==genesin[i]),])
              ,]
          ),breaks = 10))]
    
    names(Col)<-rownames(projections)
    plotCol<-Col[rownames(subsetTSNE)]
    plot(subsetTSNE[,input$dimension_x4],subsetTSNE[,input$dimension_y4],col=plotCol,pch=16,axes = FALSE,frame.plot = TRUE, ann=FALSE)
    title(genesin[i],line=-1.2,adj = 0.05,cex.main=2)
    
  }
}

```



## 3D TSNE plot

```{r bj-DE-tsne_plt, eval=TRUE, echo=FALSE}
if(DEBUG)cat(file=stderr(), "output$tsne_plt\n")
geneid <- rownames(featureData[which(featureData$Associated.Gene.Name ==
                                       toupper(input$gene_id)), ])[1]

expression <- log2cpm[geneid, ]

tsneData <- cbind(projections, t(expression))
names(tsneData)[names(tsneData) == geneid] <- 'values'

p <-
  plot_ly(
    tsneData,
    x = ~ tsne1,
    y = ~ tsne2,
    z = ~ tsne3,
    type = "scatter3d",
    hoverinfo = "text",
    text = paste('Cluster:', as.numeric(as.character(projections$dbCluster))),
    mode = 'markers',
    marker = list(
      size = 2,
      line = list(width = 0),
      color =  ~ values,
      colors = 'Greens'
    )
  )
layout(p, title = toupper(input$gene_id))

```

## scater QC

```{r bj-DE-scater, eval=FALSE, echo=FALSE, warning=FALSE }
cat(file = stderr(), paste(class(gbm_log), collapse = "\n"))
featureDataReact <- dataTables$featuredata[useGenes, ]
# featureData = dataTables$featuredata[useGenes, ]
scaterReads <- scaterReadsFunc(gbm, featureDataReact)
n = min(nrow(scaterReads),50)
scater::plotQC(scaterReads, type = "highest-expression", colour_cells_by = "fixed", n = n)
```



